# 柔整 Ver3 金額計算 仕様書（SPEC.md）

最終更新: 2026-02-17
対象: Ver3_amounts（来院ヘッダ金額計算・安全制御）

---

## 0. 業務背景と目的

### 業務背景

本システムは **接骨院（柔道整復師）の患者管理・保険請求業務** を支援する。

1. **来院受付** — 患者の来院を記録し、施術内容・部位・傷病名を登録する
2. **施術記録** — 毎回の施術内容、所見、経過を記録する
3. **金額算定** — 保険算定ルールに基づき、初検料・後療料・加算等を自動計算する
4. **窓口会計** — 患者負担額（窓口負担）を算出し、徴収する
5. **療養費支給申請書の作成** — 施術内容・金額を集計し、公的機関（健康保険組合・市区町村等）へ提出する正式書類を生成する
6. **保険請求** — 申請書を提出し、保険者から療養費の支払いを受ける

### 重要事項

- **療養費支給申請書は公的機関に提出する正式書類であり、記載内容に誤りがあってはならない**
- 金額の誤算定は返戻（差し戻し）・査定（減額）の原因となり、経営に直接影響する
- 不正請求は法的処分の対象となるため、算定ルールの厳密な遵守が必須である
- 本システムの金額計算ロジックは上記を前提に設計されている

### 設計方針

- レセプト事故ゼロ（返戻・査定を最小化）
- UI入力を尊重しつつ、算定不可は自動制御
- 抑制・算定不可・減額の理由を必ず残す（監査耐性）
- 疑義がある場合は要確認フラグで人の判断を促す（自動却下しない）

---

## 1. 前提（データモデル）

- **ケース（caseKey）** = 1つの受傷エピソード
- **別ケース判定**: UIで caseKey を新規作成した場合のみ別ケース
- Ver3は原則最大2部位（将来拡張で3部位以上を想定）

---

## 2. 判定優先順位（絶対順序）

1) 30日判定  
2) 受傷日経過日数による加算可否判定  
3) 区分確定（初検/再検/後療）  
4) 患者×月 上限制御  
5) 要確認フラグ付与  
6) 多部位逓減  
7) 長期減額  
8) 来院合計算出  

---

## 3. 30日ルール

- 前回来院から **30日以内（≤30日）** → 継続（後療）
- 前回来院から **31日以上（>30日）** → 初検リセット
- 初検リセット時は長期減額カウントもリセット

---

## 4. 患者×月 上限（最上位ルール）

同一患者・同一月において最大1回：

- 初検料
- 再検料
- 相談支援料

別ケースでも合算で1回。

---

## 5. 初検料

### 算定可能
- 当月に未算定
- かつ
  - caseKey新規
  - または30日超リセット

### 抑制
- 当月に既算定 → 初検料=0
- 区分は「後療」
- 要確認=TRUE

---

## 6. 再検料

### 算定可能（当月1回のみ）

以下をすべて満たす場合：

- 当月に再検料未算定
- 当月に初検料算定済
- 当該来院日が「当月の初検料算定日の次回来院日」

#### 次回来院日の定義
当月に初検料を算定した日より後に発生した、
最初の来院日を指す。

### 抑制
- 条件未満 → 再検料=0
- 当月既算定済 → 再検料=0

---

## 7. 後療料

### 定義
初検日以外の継続施術日に算定する基本施術料。

区分が「後療」または「再検」の日に算定対象。

### 算定条件
- 30日以内の継続来院日
- 同月別ケース抑制初回日（区分=後療）
- 再検料算定日（再検＋後療）

### 算定不可
- 初検料算定日
- 施術実態がない日

### 部位単位
部位×傷病単位で算定。逓減対象。

---

## 8. 相談支援料

- 初検料を算定する初検日にのみ算定可
- 当月1回のみ

---

## 9. 加算（冷罨法・温罨法・電療）

### 共通
- 部位×傷病単位で判定
- 算定不可日は金額0円
- チェックは消さない

---

### 9.1 冷罨法

#### 打撲・捻挫
- 受傷日または翌日初検のみ算定可

#### 脱臼
- 受傷日から5日以内

#### 骨折・不全骨折
- 受傷日から7日以内

---

### 9.2 温罨法・電療

#### 打撲・捻挫・脱臼
- 受傷後5日間は算定不可
- 6日目以降算定可

#### 骨折・不全骨折
- 受傷後7日間は算定不可
- 8日目以降算定可

再検/後療と同時算定可。

---

## 10. 多部位逓減

対象:
- 後療料
- 冷罨法
- 温罨法
- 電療

- 1部位目：100%
- 2部位目：100%
- 3部位目：60%
- 4部位目以降算定不可

---

## 11. 長期減額

### 起算月
- 初検月
- 初検が16日以降は翌月起算

### 75%
- 起算から5か月超（6か月目以降）

### 50%
- 連続5か月以上、各月10回以上
- 翌月以降50%

### 30日リセット
長期カウントもリセット

---

## 12. 実装安全弁

算定不可でも：

1. チェックは残す
2. 金額は0
3. 要確認=TRUE
4. 要確認理由に記録（;区切り）

例:
冷罨法 算定不可（捻挫：受傷後3日）

---

## 13. 来院合計

### 設計統一（推奨）

明細合計 = 後療料 + 冷罨法 + 温罨法 + 電療  
来院合計 = 初検料 + 再検料 + 相談支援料 + 明細合計

### 端数処理
- 窓口負担のみ roundToUnit_ 適用
- 保険請求額は丸めない

---

## 14. UI会計ブロック

### 表示セル（患者画面シート）

| セル | 内容 |
|------|------|
| D2 | 来院合計 |
| D3 | 窓口負担（徴収額） |
| D4 | 保険請求額 |
| D5 | 要確認（TRUE/FALSE） |
| D6 | 要確認理由（セル内改行表示） |

### 実装ルール

- セル番地は `UI` 定数で管理（直書き禁止）
- 書き込みタイミング: `saveVisit_V3` の明細upsert後、UI更新前
- 要確認理由: 内部保持は `;` 区切り、UI表示時に `;` → `\n` に変換
- D6 は wrap 有効（`setWrap(true)`）
- `clearEntryUI_V3` で会計ブロックもクリア
- `clearAfterSaveUI_V3_` では保存直後の確認用に残す

### 処理順序（saveVisit_V3）

1. 来院ケース保存
2. 金額計算
3. 来院ヘッダupsert
4. 明細upsert
5. **UI会計ブロック更新**
6. 経過履歴更新 / UIクリア

---

## 15. テスト観点

- 同月別ケース初回 → 初検抑制・要確認TRUE
- 月またぎ別ケース → 初検可（ただし月内上限遵守）
- 再検は当月初検の次回来院のみ
- 冷温電は受傷日制御正確
- 30日境界：30日継続・31日初検
- 長期減額と30日リセット整合

## 単価管理

- すべての単価は設定シートから取得する。
- 金額計算ロジック内に固定値を直接記述してはならない。
- 単価変更時は設定シートのみ修正する。