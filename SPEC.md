# 柔整 Ver3 金額計算 仕様書（SPEC.md）

最終更新: 2026-02-22
対象: Ver3_amounts（来院ヘッダ金額計算・安全制御）

---

## 0. 業務背景と目的

### 業務背景

本システムは **接骨院（柔道整復師）の患者管理・保険請求業務** を支援する。

1. **来院受付** — 患者の来院を記録し、施術内容・部位・傷病名を登録する
2. **施術記録** — 毎回の施術内容、所見、経過を記録する
3. **金額算定** — 保険算定ルールに基づき、初検料・後療料・加算等を自動計算する
4. **窓口会計** — 患者負担額（窓口負担）を算出し、徴収する
5. **療養費支給申請書の作成** — 施術内容・金額を集計し、公的機関（健康保険組合・市区町村等）へ提出する正式書類を生成する
6. **保険請求** — 申請書を提出し、保険者から療養費の支払いを受ける

### 重要事項

- **療養費支給申請書は公的機関に提出する正式書類であり、記載内容に誤りがあってはならない**
- 金額の誤算定は返戻（差し戻し）・査定（減額）の原因となり、経営に直接影響する
- 不正請求は法的処分の対象となるため、算定ルールの厳密な遵守が必須である
- 本システムの金額計算ロジックは上記を前提に設計されている

### 設計方針

- レセプト事故ゼロ（返戻・査定を最小化）
- UI入力を尊重しつつ、算定不可は自動制御
- 抑制・算定不可・減額の理由を必ず残す（監査耐性）
- 疑義がある場合は要確認フラグで人の判断を促す（自動却下しない）

---

## 1. 前提（データモデル）

### キー体系

| キー | 形式 | 単位 | 例 |
|------|------|------|-----|
| visitKey | `患者ID_yyyy-MM-dd` | 1来院日 | `hirayamaka_2026-01-01` |
| caseKey | `患者ID_エピソード開始日_C{caseNo}` | 1受傷エピソード | `hirayamaka_2026-01-01_C1` |

- **visitKey** = 患者×来院日の一意キー（来院ヘッダの主キー）
- **caseKey** = 1つの受傷エピソード（初検日で固定、エピソード中は不変）
- **来院ケース行の一意キー** = `visitKey + caseNo` の複合キー
- **別ケース判定**: UIで caseKey を新規作成した場合のみ別ケース
- 同一エピソード（初検→再検→後療…）は同一 caseKey を共有する
- Ver3は原則最大2部位（将来拡張で3部位以上を想定）

---

## 2. 判定優先順位（絶対順序）

1) 30日判定  
2) 受傷日経過日数による加算可否判定  
3) 区分確定（初検/再検/後療）  
4) 患者×月 上限制御  
5) 要確認フラグ付与  
6) 多部位逓減  
7) 長期減額  
8) 来院合計算出  

---

## 3. 30日ルール

- 前回来院から **30日以内（≤30日）** → 継続（後療）
- 前回来院から **31日以上（>30日）** → 初検リセット
- 初検リセット時は長期減額カウントもリセット

---

## 4. 患者×月 上限（最上位ルール）

同一患者・同一月において最大1回：

- 初検料
- 再検料
- 相談支援料

別ケースでも合算で1回。

---

## 5. 初検料

### 算定可能
- 当月に未算定
- かつ
  - caseKey新規
  - または30日超リセット

### 抑制
- 当月に既算定 → 初検料=0
- 区分は「後療」
- 要確認=TRUE

---

## 6. 再検料

### 算定可能（当月1回のみ）

以下をすべて満たす場合：

- 当月に再検料未算定
- 当月に初検料算定済
- 当該来院日が「当月の初検料算定日の次回来院日」

#### 次回来院日の定義
当月に初検料を算定した日より後に発生した、
最初の来院日を指す。

### 抑制
- 条件未満 → 再検料=0
- 当月既算定済 → 再検料=0

---

## 7. 後療料

### 定義
初検日以外の継続施術日に算定する基本施術料。

区分が「後療」または「再検」の日に算定対象。

### 算定条件
- 30日以内の継続来院日
- 同月別ケース抑制初回日（区分=後療）
- 再検料算定日（再検＋後療）

### 算定不可
- 初検料算定日
- 施術実態がない日

### 部位単位
部位×傷病単位で算定。逓減対象。

---

## 8. 相談支援料

- 初検料を算定する初検日にのみ算定可
- 当月1回のみ

---

## 9. 加算（冷罨法・温罨法・電療）

### 共通
- 部位×傷病単位で判定
- 算定不可日は金額0円
- チェックは消さない

---

### 9.1 冷罨法

受傷日からの経過日数（dayDiff = 施術日 − 受傷日）で判定する。

| 傷病種別 | 算定可能条件 | dayDiff |
|----------|-------------|---------|
| 打撲・捻挫・挫傷 | 受傷日当日または翌日 | ≤ 1 |
| 脱臼 | 受傷日から5日以内 | ≤ 4 |
| 骨折・不全骨折 | 受傷日から7日以内 | ≤ 6 |

※ 初検日に限らず、上記日数内であれば後療日でも算定可。

---

### 9.2 温罨法・電療

受傷日からの経過日数（dayDiff = 施術日 − 受傷日）で判定する。

| 傷病種別 | 算定不可期間 | 算定可能条件 | dayDiff |
|----------|-------------|-------------|---------|
| 打撲・捻挫・挫傷・脱臼 | 受傷後5日間 | 6日目以降 | ≥ 5 |
| 骨折・不全骨折 | 受傷後7日間 | 8日目以降 | ≥ 7 |

#### 初検日特例（厚労省通知 P43）
- 骨折・不全骨折の受傷日から8日以上経過していても、**整復・固定を行った初検日には温罨法を算定不可**
- 脱臼・打撲・捻挫の受傷日から6日以上経過していても、**整復・施療を行った初検日には温罨法を算定不可**
- ただし、初検日より**後療のみ**を行う場合は算定可

> ※ 現在のGAS実装ではこの初検日特例は未実装。将来対応予定。

再検/後療と同時算定可。

---

## 10. 多部位逓減

### 対象料金
- 後療料
- 冷罨法
- 温罨法
- 電療

※ 施療料（初検日の基本料）、整復料、固定料は逓減対象外。

### 逓減率
- 1部位目：100%
- 2部位目：100%
- 3部位目：60%
- 4部位目以降：後療料・温罨法・冷罨法・電療は算定不可（3部位目までに含む）

### 対象傷病
- 骨折・不全骨折・脱臼・捻挫・打撲の全てが対象

### 部位数減少時
- 特定部位が先に治癒し部位数が減少した場合、減少後の部位数に応じた逓減率を適用
- 3部位以上の施術期間中に、ある施術日で2部位のみ施術した場合でも逓減率は変更されない（他部位が治癒した場合のみ変更）

### 端数処理
- 部位ごとの算定過程で1円未満の端数が生じた場合は、その都度小数点以下1桁目を四捨五入

---

## 11. 長期減額

### 対象傷病
- 脱臼・打撲・捻挫・挫傷が対象
- **骨折・不全骨折は長期減額の対象外**

### 対象料金
- 後療料・温罨法・冷罨法・電療

### 起算月
- 各部位の初検日を含む月（ただし初検日が月の16日以降の場合は翌月）から起算
- 部位ごとに個別に起算する

### 75%
- 起算から5か月超（6か月目以降）

### 50%
- 起算から5か月超、かつ月10回以上の施術を5か月連続
- 翌月（6か月目）以降50%

### 長期かつ頻回の特別料金
- 50%算定の場合、75%相当額との差額の範囲内で患者から特別の料金を徴収可能
- 国の公費負担医療受給者からは特別料金の徴収不可

### 30日リセット
長期カウントもリセット

---

## 12. 実装安全弁

算定不可でも：

1. チェックは残す
2. 金額は0
3. 要確認=TRUE
4. 要確認理由に記録（;区切り）

例:
冷罨法 算定不可（捻挫：受傷後3日）

---

## 13. 来院合計

### 設計統一（推奨）

明細合計 = 基本料（施療料/後療料/整復料/固定料） + 冷罨法 + 温罨法 + 電療 + 待機料
来院合計 = 初検料 + 再検料 + 相談支援料 + Σ明細合計（全部位）

※ 基本料は傷病種別と区分（初検/再検/後療）に応じて自動決定（§17参照）

### 端数処理
- 窓口負担のみ roundToUnit_ 適用
- 保険請求額は丸めない

---

## 14. 施術明細upsert（ステップ④）

### 目的

saveVisit_V3 の金額計算結果を施術明細シートへ部位単位で書き込む。
申請書_転記データ（Ver3_transferData.js）が施術明細を参照するため必須。

### detailID

```
detailID = visitKey + "_C" + caseNo + "_P" + partOrder
```

- 例: `P0001_2026-02-15_C1_P1`
- 既存行があれば上書き、なければ末尾追記

### 施術明細シート列

| 列名 | 内容 | 備考 |
|------|------|------|
| detailID | 一意キー | visitKey_C{n}_P{n} |
| visitKey | 来院キー | |
| 患者ID | | |
| 施術日 | | |
| 区分 | 初検/再検/後療 | |
| caseNo | ケース番号(1/2) | |
| 部位 | 部位名 | |
| 傷病 | 傷病名 | |
| 部位順位 | 1,2,3... | 多部位逓減に使用 |
| 冷 | チェックボックス | |
| 温 | チェックボックス | |
| 電 | チェックボックス | |
| 受傷日_確定 | Date | |
| 係数 | 逓減係数 | 確定値 |
| 基本料_確定 | 施療料or後療料 | 確定値 |
| 初検相談_確定 | 0固定 | 確定値 |
| 冷_確定 | 冷罨法金額 | 確定値 |
| 温_確定 | 温罨法金額 | 確定値 |
| 電_確定 | 電療金額 | 確定値 |
| 待機_確定 | 待機料金額 | 確定値 |
| 行合計_確定 | (基本+冷+温+電+待機)*係数 | 確定値 |

### データソース

`calcHeaderAmountsByVisitKey_V3_` の返り値 `amounts.details`:
- `case1Parts`: ケース1の部位別内訳配列
- `case2Parts`: ケース2の部位別内訳配列

各要素は `calcOnePartAmount_V3_` が返すオブジェクト:
`{ base, cold, warm, electro, taiki, coef, total, byomei, bui, partOrder, injuryDate, coldChk, warmChk, electroChk }`

### 実装関数

`upsertDetailRows_V3_(detailSh, detailMap, ctx)` — Ver3_core.js

---

## 15. UI会計ブロック

### 表示セル（患者画面シート）

| セル | 内容 |
|------|------|
| D2 | 来院合計 |
| D3 | 窓口負担（徴収額） |
| D4 | 保険請求額 |
| D5 | 要確認（TRUE/FALSE） |
| D6 | 要確認理由（セル内改行表示） |

### 実装ルール

- セル番地は `UI` 定数で管理（直書き禁止）
- 書き込みタイミング: `saveVisit_V3` の明細upsert後、UI更新前
- 要確認理由: 内部保持は `;` 区切り、UI表示時に `;` → `\n` に変換
- D6 は wrap 有効（`setWrap(true)`）
- `clearEntryUI_V3` で会計ブロックもクリア
- `clearAfterSaveUI_V3_` では保存直後の確認用に残す

### 処理順序（saveVisit_V3）

1. 来院ケース保存
2. 金額計算
3. 来院ヘッダupsert
4. 明細upsert
5. **UI会計ブロック更新**
6. 経過履歴更新 / UIクリア

---

## 15-2. UI入力バリデーション

### 患者画面の部位入力行レイアウト

```
A=部位名, B=傷病名, C=受傷日, D=冷, E=温, F=電, G=終了日
```

Case1: 行12,13 / Case2: 行27,28（各2部位）

### 傷病名プルダウン（B列）

傷病名欄（B12, B13, B27, B28）にデータバリデーション（プルダウン）を設定する。

#### 選択肢
設定シートの「傷病名一覧」列（C列）から取得する。

| 傷病名 | detectInjuryType_V3_ の返り値 |
|--------|-------------------------------|
| 打撲 | 打撲 |
| 捻挫 | 捻挫 |
| 挫傷 | 挫傷 |
| 脱臼 | 脱臼 |

※ 骨折・不全骨折は将来追加予定。

#### 設計意図
- 表記ゆれを防ぎ、`detectInjuryType_V3_` が確実に判定できるようにする
- 部位名（A列）は自由テキストのまま（「右肩関節」「腰部」等）
- プルダウン設定は `setupValidation_V3` メニューで一括設定

---

## 16. テスト観点

- 同月別ケース初回 → 初検抑制・要確認TRUE
- 月またぎ別ケース → 初検可（ただし月内上限遵守）
- 再検は当月初検の次回来院のみ
- 冷温電は受傷日制御正確
- 30日境界：30日継続・31日初検
- 長期減額と30日リセット整合

## 単価管理

- すべての単価は設定シートから取得する。
- 金額計算ロジック内に固定値を直接記述してはならない。
- 単価変更時は設定シートのみ修正する。

### 設定シート キー一覧（A列→B列）

GASの `AM_SET_KEYS` / `loadSettings_V3_` に対応する。

| A列（キー名） | B列（値） | 備考 |
|--------------|----------|------|
| `初検料` | 1550 | §20参照 |
| `初検時相談支援料` | 100 | 同月1回 |
| `再検料` | 410 | |
| `施療料_打撲` | 760 | 初検日の基本料 |
| `施療料_捻挫` | 760 | |
| `施療料_挫傷` | 760 | 打撲の部で算定 |
| `後療料_打撲` | 505 | 再検/後療日の基本料 |
| `後療料_捻挫` | 505 | |
| `後療料_挫傷` | 505 | 打撲の部で算定 |
| `整復料_脱臼` | ※部位別 | §17.2 初検日（2,600〜9,300円） |
| `後療料_脱臼` | 720 | §17.2 再検/後療日 |
| `冷罨法` | 85 | |
| `温罨法` | 75 | |
| `電療` | 33 | |
| `待機_打撲捻挫挫傷` | ※院固有 | 温/電いずれか算定時 |
| `多部位_3部位目係数` | 0.6 | §10 |
| `窓口端数単位` | 10 | roundToUnit_用 |

※ `整復料_脱臼` は部位により単価が異なる（SPEC §20参照）。
  現時点では単一値を設定し、部位別対応は将来拡張とする。

---

## 17. 傷病種別ごとの算定体系

### 17.1 対象傷病種別と分類

柔道整復施術療養費の対象は外傷性が明らかな以下の5種別。

| 分類 | 傷病種別 | 初検日の料金名 | 後療日の料金名 | 医師同意 |
|------|---------|-------------|-------------|---------|
| A | 骨折 | 整復料 | 後療料（骨折） | 応急手当以外は必要 |
| A | 不全骨折 | 固定料 | 後療料（不全骨折） | 応急手当以外は必要 |
| B | 脱臼 | 整復料（脱臼） | 後療料（脱臼） | 応急手当以外は必要 |
| C | 打撲 | 施療料 | 後療料（打撲） | 不要 |
| C | 捻挫 | 施療料 | 後療料（捻挫） | 不要 |
| C | 挫傷（肉ばなれ） | 施療料 | 後療料（打撲の部で算定） | 不要 |

※ 挫傷は打撲の部の所定料金で算定する（厚労省通知 P40）。
※ 挫傷の算定部位は胸部・背部・上腕部・前腕部・大腿部・下腿部の6部位に限る。

### 17.2 脱臼の算定ルール

#### 基本料

| 区分 | 料金 | 設定シートキー |
|------|------|-------------|
| 初検日 | 整復料（脱臼） | `整復料_脱臼` |
| 再検・後療日 | 後療料（脱臼） | `後療料_脱臼` |

#### 医師同意
- 応急手当を除き、施術に対する**担当医師の同意が必要**
- 同意を求める医師は原則として当該負傷の診療を担当している医師
- 申請書の「摘要」欄に同意した医師の氏名と同意年月日を記載

#### 長期施術
- 打撲・捻挫と同様に**5か月超で75%逓減**、長期かつ頻回で50%逓減の対象
- 3か月を超えて継続する場合は「長期施術継続理由書」の添付が必要（§19参照）

#### 多部位逓減
- 3部位目は60%逓減の対象（打撲・捻挫と同じ）
- 4部位目以降の後療料・罨法料・電療料は算定不可（3部位目までに含まれる）

#### 顎関節脱臼の特例
- 左右各1部位として算定可
- 同時に生じた同側の顔面部打撲は脱臼の所定料金のみで算定（別途算定不可）

### 17.3 骨折・不全骨折の算定ルール（将来実装）

> 現時点では未実装。以下は仕様定義のみ。

#### 基本料

| 区分 | 骨折 | 不全骨折 | 設定シートキー |
|------|------|---------|-------------|
| 初検日 | 整復料（部位別） | 固定料（部位別） | `整復料_骨折_*` / `固定料_*` |
| 再検・後療日 | 後療料（骨折） | 後療料（不全骨折） | `後療料_骨折` / `後療料_不全骨折` |

#### 医師同意
- 脱臼と同様、応急手当を除き担当医師の同意が必要

#### 特殊骨折の制限
- 頭蓋骨・脊椎・胸骨その他の複雑骨折は原則算定不可
- 特に医師から後療を依頼された場合に限り算定可（摘要欄に記載）
- 膝蓋骨骨折の後療も同様

#### 金属副子等加算
- 骨折・脱臼の整復および不全骨折の固定に際し金属副子等を使用した場合に加算
- 後療時の交換は**2回まで**加算可
- 使用・交換した日を申請書摘要欄と施術録に記載

#### 柔道整復運動後療料
- 骨折・不全骨折・脱臼の後療時に運動機能回復目的の各種運動を行った場合
- 1日320円、負傷日から15日間を除き、週1回程度、月5回限度
- 負傷日が月の15日以前で当月16日以降に後療がない場合は月2回限度
- 負傷日が月の16日以降の場合は当月算定不可

---

## 18. 近接部位ルール

### 概要
同時に生じた近接部位の負傷は、上位の施術料のみで算定し、別途算定不可。

### ルール一覧

#### 骨折と捻挫
- 関節近接部位の骨折と同時に生じた当該関節の捻挫 → **骨折の所定料金のみ**

#### 捻挫と打撲・挫傷
- 頸部・腰部・肩関節のうち2部位の捻挫と同時に生じた背部打撲（肩部含む）/挫傷 → **捻挫の所定料金のみ**
- 左右の肩関節捻挫と同時に生じた頸部捻挫/背部打撲 → **肩関節捻挫の所定料金のみ**

#### 骨折・脱臼と下位負傷
- 指・趾骨の骨折/脱臼と同時に生じた不全骨折/捻挫/打撲 → **骨折/脱臼の所定料金のみ**

#### 近接部位の範囲
- 原則: 当該捻挫部位から**上下2関節**までの範囲
- 例外（上部・下部限定）:
  - 手関節捻挫 ↔ 前腕部打撲（上部に限る）
  - 肘関節捻挫 ↔ 前腕部打撲（下部）/ 上腕部打撲（上部）
  - 肩関節捻挫 ↔ 上腕部打撲（下部に限る）
  - 足関節捻挫 ↔ 下腿部打撲（上部に限る）
  - 膝関節捻挫 ↔ 下腿部打撲（下部）/ 大腿部打撲（上部）
  - 股関節捻挫 ↔ 大腿部打撲（下部に限る）

> ※ 現在のGAS実装では近接部位チェックは未実装。将来、3部位以上対応時に実装予定。

---

## 19. 長期施術継続理由書

- 打撲・捻挫の施術が初検日から**3か月を超えて**継続する場合
- 負傷部位、症状、施術継続が必要な理由を明記した「長期施術継続理由書」を申請書に添付
- 3か月超かつ月の施術回数が高頻度の場合は、部位ごとに頻度が高い施術が必要な理由も記載

> ※ 現在のGAS実装では長期施術継続理由書のアラート/自動生成は未実装。将来対応予定。

---

## 20. 令和6年 単価一覧（参考）

令和6年6月1日施行（一部10月1日施行）。
設定シートに登録する値の根拠として参照する。

### 施術の内容や部位数によらないもの

| 項目 | 単価 | 備考 |
|------|------|------|
| 初検料 | 1,550円 | |
| 初検時相談支援料 | 100円 | 同月1回のみ |
| 再検料 | 410円 | |
| 往療料 | 2,300円 | 4km超は2,550円 |
| 明細書発行体制加算 | 10円 | 同月1回のみ（R6.10〜） |

### 施療料（初検日）

| 傷病種別 | 単価 |
|----------|------|
| 打撲 | 760円 |
| 捻挫 | 760円 |

### 後療料（再検・後療日）

| 傷病種別 | 単価 | 備考 |
|----------|------|------|
| 打撲 | 505円 | |
| 捻挫 | 505円 | |
| 挫傷 | 505円 | 打撲の部で算定 |
| 脱臼 | 720円 | |
| 骨折 | 850円 | |
| 不全骨折 | 720円 | |

### 加算

| 項目 | 単価 | 備考 |
|------|------|------|
| 冷罨法 | 85円 | |
| 温罨法 | 75円 | |
| 電療 | 33円 | |
| 金属副子等加算 | 1,000円 | 3回まで（骨折・脱臼・不全骨折） |
| 柔道整復運動後療料 | 320円 | 月5回限度（骨折・脱臼・不全骨折） |
| 施術情報提供料 | 1,000円 | 骨折等の保険医療機関紹介時 |

### 逓減率

| 条件 | 逓減率 |
|------|--------|
| 3部位目 | 60% |
| 4部位目以降 | 算定不可 |
| 5か月超（長期） | 75% |
| 5か月超かつ月10回以上を5か月連続（長期＋頻回） | 50% |

### 初検料加算

| 項目 | 単価 |
|------|------|
| 時間外加算 | 設定シート参照 |
| 休日加算 | 設定シート参照 |
| 深夜加算 | 設定シート参照 |